<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Rahumi Admin</title>
    <link rel="stylesheet" href="styles/admin.css">
    <!-- SortableJS for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
    <!-- ==================== LOGIN VIEW ==================== -->
    <div id="login-view" class="view">
        <div class="login-container">
            <div class="login-header">
                <h1>ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                <p>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† ÙÙ‚Ø·</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <input type="email" id="email" required placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button type="submit" class="btn btn-primary" id="login-btn">
                    <span class="btn-text">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                    <span class="btn-loader hidden">â³</span>
                </button>
                <p id="login-error" class="error-message hidden"></p>
            </form>
        </div>
    </div>

    <!-- ==================== DASHBOARD VIEW ==================== -->
    <div id="dashboard-view" class="view hidden">
        <header class="dashboard-header">
            <h1>ğŸ® Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h1>
            <div class="header-actions">
                <button id="save-btn" class="btn btn-success">
                    <span class="btn-text">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</span>
                    <span class="btn-loader hidden">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</span>
                </button>
                <button id="logout-btn" class="btn btn-secondary">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
            </div>
        </header>

        <main class="dashboard-content">
            <!-- Status Messages -->
            <div id="status-message" class="status-message hidden"></div>

            <!-- ===== SITE DATA SECTION ===== -->
            <section class="card">
                <h2>ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="profile-name">Ø§Ù„Ø§Ø³Ù…</label>
                        <input type="text" id="profile-name" placeholder="Ø±Ø­ÙˆÙ…ÙŠ - Rahumi">
                    </div>
                    <div class="form-group">
                        <label for="profile-welcome">Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨</label>
                        <input type="text" id="profile-welcome" placeholder="Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ...">
                    </div>
                    <div class="form-group full-width">
                        <label for="profile-intro">Ø§Ù„Ù†Øµ Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ</label>
                        <textarea id="profile-intro" rows="2" placeholder="ØµØ§Ù†Ø¹ Ù…Ø­ØªÙˆÙ‰..."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="profile-about">Ù†Ø¨Ø°Ø© Ø¹Ù†ÙŠ</label>
                        <textarea id="profile-about" rows="3" placeholder="ØªØ¬Ù…Ø¹Ù†Ø§ Ù„Ø­Ø¸Ø§Øª..."></textarea>
                    </div>
                </div>
            </section>

            <!-- ===== SOCIAL LINKS SECTION ===== -->
            <section class="card">
                <h2>ğŸ”— Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ</h2>
                <div class="form-grid" id="social-links-container">
                    <!-- Will be populated dynamically -->
                </div>
            </section>

            <!-- ===== ROBLOX MAPS SECTION ===== -->
            <section class="card">
                <h2>ğŸ® Ø®Ø±Ø§Ø¦Ø· Ø±ÙˆØ¨Ù„ÙˆÙƒØ³</h2>
                <div id="links-container">
                    <!-- Channel containers will be generated here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ==================== FIREBASE CONFIG ====================
        // IMPORTANT: Copy firebase-config.example.js to firebase-config.js and fill in your values
        // firebase-config.js is git-ignored for security
        let firebaseConfig;
        try {
            const configModule = await import('./scripts/firebase-config.js');
            firebaseConfig = configModule.firebaseConfig;
        } catch (e) {
            console.error('Firebase config not found! Please create scripts/firebase-config.js');
            alert('Ø®Ø·Ø£: Ù…Ù„Ù Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø¥Ù†Ø´Ø§Ø¡ scripts/firebase-config.js');
            throw e;
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ==================== DOM ELEMENTS ====================
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const saveBtn = document.getElementById('save-btn');
        const statusMessage = document.getElementById('status-message');

        // ==================== AUTH STATE OBSERVER ====================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                await loadDashboardData();
            } else {
                // User is signed out
                loginView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
            }
        });

        // ==================== LOGIN HANDLER ====================
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            setButtonLoading(loginBtn, true);
            hideError();

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showError(getErrorMessage(error.code));
            } finally {
                setButtonLoading(loginBtn, false);
            }
        });

        // ==================== LOGOUT HANDLER ====================
        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });

        // ==================== LOAD DATA ====================
        async function loadDashboardData() {
            showStatus('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            try {
                const docRef = doc(db, 'content', 'main');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderDashboard(data);
                    showStatus('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'success');
                } else {
                    showStatus('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸.', 'warning');
                    renderEmptyDashboard();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showStatus('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message, 'error');
            }
        }

        // ==================== RENDER DASHBOARD ====================
        function renderDashboard(data) {
            // Profile data
            document.getElementById('profile-name').value = data.profile?.name || '';
            document.getElementById('profile-welcome').value = data.profile?.welcome_message || '';
            document.getElementById('profile-intro').value = data.profile?.intro_text || '';
            document.getElementById('profile-about').value = data.profile?.about_text || '';

            // Social links
            renderSocialLinks(data.socialLinks || {});

            // Maps
            renderMaps(data.maps || {});
        }

        function renderEmptyDashboard() {
            document.getElementById('social-links-container').innerHTML = '';
            document.getElementById('links-container').innerHTML = '';
        }

        function renderSocialLinks(socialLinks) {
            const container = document.getElementById('social-links-container');
            container.innerHTML = '';

            for (const [name, url] of Object.entries(socialLinks)) {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label>${name}</label>
                    <input type="url" data-social-key="${name}" value="${url}" placeholder="https://...">
                `;
                container.appendChild(div);
            }
        }

        function renderMaps(maps) {
            const container = document.getElementById('links-container');
            container.innerHTML = '';

            for (const [channelName, mapList] of Object.entries(maps)) {
                const channelDiv = document.createElement('div');
                channelDiv.className = 'channel-container';
                channelDiv.dataset.channel = channelName;

                channelDiv.innerHTML = `
                    <div class="channel-header">
                        <h3>ğŸ“º ${channelName}</h3>
                        <button type="button" class="btn btn-small btn-add" onclick="addNewMap('${channelName}')">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø±ÙŠØ·Ø©</button>
                    </div>
                    <div class="maps-list" id="maps-${channelName.replace(/\s/g, '-')}">
                        ${mapList.map((map, index) => createMapCard(channelName, map, index)).join('')}
                    </div>
                `;

                container.appendChild(channelDiv);

                // Initialize SortableJS on the maps list
                const mapsList = channelDiv.querySelector('.maps-list');
                new Sortable(mapsList, {
                    animation: 150,
                    ghostClass: 'map-card-ghost',
                    handle: '.drag-handle',
                    onEnd: () => {
                        // Order is automatically updated in DOM
                    }
                });
            }
        }

        function createMapCard(channelName, map, index) {
            return `
                <div class="map-card" data-channel="${channelName}">
                    <div class="drag-handle">â˜°</div>
                    <div class="map-card-content">
                        <div class="form-group">
                            <label>Ø§Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
                            <input type="text" class="map-name" value="${escapeHtml(map.map_name || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©">
                        </div>
                        <div class="form-group">
                            <label>Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
                            <input type="url" class="video-link" value="${escapeHtml(map.video_link || '')}" placeholder="https://youtu.be/...">
                        </div>
                        <div class="form-group">
                            <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
                            <input type="url" class="map-link" value="${escapeHtml(map.map_link || '')}" placeholder="https://www.roblox.com/games/...">
                        </div>
                    </div>
                    <button type="button" class="btn btn-danger btn-delete" onclick="deleteMapCard(this)">ğŸ—‘ï¸</button>
                </div>
            `;
        }

        // ==================== MAP ACTIONS ====================
        window.addNewMap = function(channelName) {
            const mapsList = document.getElementById(`maps-${channelName.replace(/\s/g, '-')}`);
            const newCard = document.createElement('div');
            newCard.className = 'map-card';
            newCard.dataset.channel = channelName;
            newCard.innerHTML = `
                <div class="drag-handle">â˜°</div>
                <div class="map-card-content">
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
                        <input type="text" class="map-name" value="" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</label>
                        <input type="url" class="video-link" value="" placeholder="https://youtu.be/...">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø©</label>
                        <input type="url" class="map-link" value="" placeholder="https://www.roblox.com/games/...">
                    </div>
                </div>
                <button type="button" class="btn btn-danger btn-delete" onclick="deleteMapCard(this)">ğŸ—‘ï¸</button>
            `;
            // Add to the beginning (top)
            mapsList.prepend(newCard);
        };

        window.deleteMapCard = function(button) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø±ÙŠØ·Ø©ØŸ')) {
                button.closest('.map-card').remove();
            }
        };

        // ==================== SAVE HANDLER ====================
        saveBtn.addEventListener('click', async () => {
            setButtonLoading(saveBtn, true);
            showStatus('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª...', 'info');

            try {
                const data = collectFormData();
                
                // Save to Firestore
                const docRef = doc(db, 'content', 'main');
                await setDoc(docRef, data);

                showStatus('ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase. Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹...', 'info');

                // Trigger GitHub Action
                await triggerGitHubAction();

                showStatus('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ù†Ø¬Ø§Ø­! âœ…', 'success');
            } catch (error) {
                console.error('Save error:', error);
                showStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'error');
            } finally {
                setButtonLoading(saveBtn, false);
            }
        });

        function collectFormData() {
            // Collect profile data
            const profile = {
                name: document.getElementById('profile-name').value,
                welcome_message: document.getElementById('profile-welcome').value,
                intro_text: document.getElementById('profile-intro').value,
                about_text: document.getElementById('profile-about').value,
                avatar_url: 'assets/images/rahumi_profile_picture.jpg' // Keep existing
            };

            // Collect social links
            const socialLinks = {};
            document.querySelectorAll('[data-social-key]').forEach(input => {
                socialLinks[input.dataset.socialKey] = input.value;
            });

            // Collect maps (preserving order from DOM)
            const maps = {};
            document.querySelectorAll('.channel-container').forEach(channelDiv => {
                const channelName = channelDiv.dataset.channel;
                maps[channelName] = [];

                channelDiv.querySelectorAll('.map-card').forEach(card => {
                    maps[channelName].push({
                        map_name: card.querySelector('.map-name').value,
                        video_link: card.querySelector('.video-link').value,
                        map_link: card.querySelector('.map-link').value
                    });
                });
            });

            return {
                profile,
                socialLinks,
                maps,
                contact: {
                    ads_message: 'ÙØ±ÙŠÙ‚ÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ÙŠ Ø³ÙŠÙƒÙˆÙ† Ø³Ø¹ÙŠØ¯Ø§Ù‹ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙƒÙ….'
                },
                nav: [
                    { text: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', url: 'index.html' },
                    { text: 'Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ', url: 'pages/about.html' },
                    { text: 'Ù„Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª', url: 'pages/contact.html' },
                    { text: 'Ø£Ù„Ø¹Ø§Ø¨ Ø±ÙˆØ¨Ù„ÙˆÙƒØ³', url: 'pages/roblox.html' }
                ]
            };
        }

        async function triggerGitHubAction() {
            // Get the GitHub PAT from Firebase config
            const ghPat = firebaseConfig.githubPat;
            const repoOwner = firebaseConfig.githubOwner;
            const repoName = firebaseConfig.githubRepo;

            if (!ghPat || !repoOwner || !repoName) {
                console.warn('GitHub trigger not configured. Skipping...');
                return;
            }

            const response = await fetch(
                `https://api.github.com/repos/${repoOwner}/${repoName}/actions/workflows/build-from-firebase.yml/dispatches`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${ghPat}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ref: 'main' })
                }
            );

            if (!response.ok && response.status !== 204) {
                throw new Error('Failed to trigger GitHub Action');
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function setButtonLoading(btn, loading) {
            const text = btn.querySelector('.btn-text');
            const loader = btn.querySelector('.btn-loader');
            if (loading) {
                text.classList.add('hidden');
                loader.classList.remove('hidden');
                btn.disabled = true;
            } else {
                text.classList.remove('hidden');
                loader.classList.add('hidden');
                btn.disabled = false;
            }
        }

        function showError(message) {
            loginError.textContent = message;
            loginError.classList.remove('hidden');
        }

        function hideError() {
            loginError.classList.add('hidden');
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.classList.remove('hidden');
        }

        function getErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­',
                'auth/user-disabled': 'Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø·Ù„',
                'auth/user-not-found': 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
                'auth/wrong-password': 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©',
                'auth/invalid-credential': 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'
            };
            return messages[errorCode] || 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
