<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Rahumi</title>
    <link rel="icon" href="assets/images/profile_pictures/Rahumi.jpg">
    <link rel="stylesheet" href="styles/variables.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&family=Quicksand:wght@500;700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* ==================== LOGIN VIEW ==================== */
        #login-view {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            background: var(--surface-color);
            padding: 3rem;
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .login-header {
            margin-bottom: 2rem;
        }

        .login-header .logo {
            font-family: 'Quicksand', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--primary-light);
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-color);
            background: var(--bg-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(136, 192, 166, 0.2);
        }

        /* ==================== BUTTONS ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--text-light);
            border: 2px solid var(--primary-light);
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: var(--primary-light);
            color: var(--text-color);
        }

        .btn-full { width: 100%; }

        /* Channel Buttons */
        .channel-btn {
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 2px solid var(--primary-light);
        }

        .channel-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: var(--shadow-md);
        }

        /* ==================== STATUS MESSAGES ==================== */
        .status-message {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 10px;
            font-weight: 600;
            display: none;
            text-align: center;
        }

        .status-message.show { display: block; }

        .status-message.success {
            background-color: rgba(136, 192, 166, 0.2);
            color: var(--primary-dark);
            border: 1px solid var(--primary-color);
        }

        .status-message.error {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        .status-message.loading {
            background-color: rgba(136, 192, 166, 0.1);
            color: var(--text-light);
            border: 1px solid var(--primary-light);
        }

        /* ==================== DASHBOARD VIEW ==================== */
        #dashboard-view {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .dashboard-header {
            background: var(--surface-color);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .dashboard-header h1 {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.5rem;
            color: var(--primary-dark);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .dashboard-content {
            flex: 1;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        /* ==================== CHANNEL SELECTOR ==================== */
        .channel-selector {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .channel-info {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--text-light);
        }

        /* ==================== MAP CARDS ==================== */
        .maps-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 100px;
        }

        .map-card {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid #eee;
            transition: box-shadow 0.2s, transform 0.2s;
            position: relative;
        }

        .map-card:hover {
            box-shadow: var(--shadow-md);
        }

        .drag-handle {
            cursor: grab;
            font-size: 1.25rem;
            color: var(--text-light);
            padding: 0.5rem;
            user-select: none;
        }

        .drag-handle:active { cursor: grabbing; }

        .map-card-content {
            flex: 1;
            min-width: 0;
        }

        .map-card-content h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .map-card-content .links {
            font-size: 0.8rem;
            color: var(--text-light);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .map-card-content .links a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .map-card-content .links a:hover {
            text-decoration: underline;
        }

        .delete-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #dc3545;
            color: white;
            border: 2px solid white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            box-shadow: var(--shadow-sm);
        }

        .delete-btn:hover {
            transform: scale(1.1);
            background: #c82333;
        }

        /* Drag and Drop States */
        .map-card.sortable-ghost {
            opacity: 0.4;
            background: var(--primary-light);
        }

        .map-card.sortable-chosen {
            box-shadow: 0 8px 24px rgba(136, 192, 166, 0.4);
            transform: scale(1.02);
        }

        /* ==================== MODAL ==================== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal {
            background: var(--surface-color);
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal h2 {
            font-family: 'Quicksand', sans-serif;
            color: var(--primary-dark);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .modal-actions .btn {
            flex: 1;
        }

        /* ==================== SAVE BAR ==================== */
        .save-bar {
            position: sticky;
            bottom: 0;
            background: var(--surface-color);
            padding: 1rem 2rem;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 600px) {
            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .map-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .drag-handle {
                align-self: center;
            }
        }
    </style>
</head>
<body>
    <!-- ==================== LOGIN VIEW ==================== -->
    <div id="login-view">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">üîê Admin Panel</div>
                <p>Authorized access only</p>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" required placeholder="admin@example.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required placeholder="Enter your password" autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-full" id="login-btn">Sign In</button>
            </form>
            <div id="login-status" class="status-message"></div>
        </div>
    </div>

    <!-- ==================== DASHBOARD VIEW ==================== -->
    <div id="dashboard-view" class="hidden">
        <header class="dashboard-header">
            <h1>üéÆ Content Dashboard</h1>
            <div class="header-actions">
                <button id="add-item-btn" class="btn">‚ûï Add Item</button>
                <button id="logout-btn" class="btn btn-secondary">Sign Out</button>
            </div>
        </header>

        <main class="dashboard-content">
            <!-- Status -->
            <div id="loading-indicator" class="status-message show loading">
                Loading content...
            </div>

            <!-- Channel Selector Buttons -->
            <div id="channel-buttons" class="channel-selector"></div>

            <!-- Channel Info -->
            <div id="channel-info" class="channel-info"></div>

            <!-- Maps List for Current Channel -->
            <div id="maps-list" class="maps-list"></div>
        </main>

        <footer class="save-bar">
            <button id="save-btn" class="btn" disabled>üíæ Save Changes</button>
            <div id="save-status" class="status-message" style="margin: 0; padding: 0.5rem 1rem;"></div>
        </footer>
    </div>

    <!-- ==================== ADD ITEM MODAL ==================== -->
    <div id="add-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2>‚ûï Add New Item</h2>
            <form id="add-form">
                <!-- Map Name Removed -->
                <div class="form-group">
                    <label for="add-video-link">Video Link</label>
                    <input type="url" id="add-video-link" required placeholder="https://youtu.be/...">
                </div>
                <div class="form-group">
                    <label for="add-map-link">Map Link (Roblox)</label>
                    <input type="url" id="add-map-link" required placeholder="https://www.roblox.com/games/...">
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancel-add-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn">Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // ==================== CONFIG ====================
        const firebaseConfig = {
            apiKey: "AIzaSyCurzL7xeHfumbjnXngeuib0eJZePgM2B8",
            authDomain: "rahumi-redirect.firebaseapp.com",
            projectId: "rahumi-redirect",
            storageBucket: "rahumi-redirect.firebasestorage.app",
            messagingSenderId: "508830697796",
            appId: "1:508830697796:web:682d8558d7ad9a298a6f11"
        };



        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        // ==================== STATE ====================
        let allChannelsData = {};  // All channels: { "channelName": [...maps], ... }
        let channelOrder = [];     // Preserves original channel order
        let currentChannel = null;
        let hasChanges = false;
        let sortableInstance = null;
        let editingItemCard = null; // Track which card is being edited (null = adding new)

        // ==================== DOM ELEMENTS ====================
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginStatus = document.getElementById('login-status');
        const loadingIndicator = document.getElementById('loading-indicator');
        const channelButtonsContainer = document.getElementById('channel-buttons');
        const channelInfo = document.getElementById('channel-info');
        const mapsList = document.getElementById('maps-list');
        const addItemBtn = document.getElementById('add-item-btn');
        const addModal = document.getElementById('add-modal');
        const addForm = document.getElementById('add-form');
        const cancelAddBtn = document.getElementById('cancel-add-btn');
        const saveBtn = document.getElementById('save-btn');
        const saveStatus = document.getElementById('save-status');

        // ==================== AUTH STATE ====================
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                loginView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                await loadContent();
            } else {
                loginView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
            }
        });

        // ==================== LOGIN ====================
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            showStatus(loginStatus, 'Authenticating...', 'loading');

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showStatus(loginStatus, getErrorMessage(error.code), 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        });

        // ==================== LOGOUT ====================
        logoutBtn.addEventListener('click', async () => {
            if (hasChanges && !confirm('You have unsaved changes. Are you sure you want to sign out?')) {
                return;
            }
            await signOut(auth);
        });

        // ==================== LOAD CONTENT ====================
        async function loadContent() {
            loadingIndicator.classList.remove('hidden');
            loadingIndicator.textContent = 'Loading content...';

            try {
                // Try Firestore first
                const docRef = doc(db, 'content', 'main');
                const docSnap = await getDoc(docRef);

                if (docSnap.exists() && docSnap.data().maps) {
                    const data = docSnap.data();
                    allChannelsData = data.maps;
                    // Use saved channel order if available, otherwise use keys
                    channelOrder = data.channelOrder || Object.keys(allChannelsData);
                    console.log('Loaded from Firestore:', channelOrder);
                } else {
                    // Fallback: Load from local links.json
                    loadingIndicator.textContent = 'Loading from local JSON...';
                    // Fallback: Load from local links.json with cache busting
                    loadingIndicator.textContent = 'Loading from local JSON...';
                    const response = await fetch('config/links.json?t=' + new Date().getTime());
                    if (!response.ok) throw new Error('Failed to load links.json');
                    allChannelsData = await response.json();
                    // Preserve the order from JSON (object keys in insertion order)
                    channelOrder = Object.keys(allChannelsData);
                    console.log('Loaded from links.json:', channelOrder);
                }

                // Render channel buttons
                renderChannelButtons();

                // Select first channel by default
                if (channelOrder.length > 0) {
                    switchChannel(channelOrder[0]);
                }

                loadingIndicator.classList.add('hidden');
            } catch (error) {
                console.error('Error loading content:', error);
                loadingIndicator.textContent = 'Error loading content: ' + error.message;
                loadingIndicator.className = 'status-message show error';
            }
        }

        // ==================== RENDER CHANNEL BUTTONS ====================
        function renderChannelButtons() {
            channelButtonsContainer.innerHTML = '';

            // Use channelOrder to ensure consistent button order
            channelOrder.forEach(channelName => {
                if (allChannelsData[channelName]) {
                    const btn = document.createElement('button');
                    btn.className = 'btn channel-btn';
                    btn.textContent = channelName;
                    btn.dataset.channel = channelName;
                    btn.onclick = () => switchChannel(channelName);
                    channelButtonsContainer.appendChild(btn);
                }
            });
        }

        function updateChannelButtonStyles() {
            const buttons = channelButtonsContainer.querySelectorAll('.channel-btn');
            buttons.forEach(btn => {
                if (btn.dataset.channel === currentChannel) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // ==================== SWITCH CHANNEL ====================
        function switchChannel(channelName) {
            currentChannel = channelName;
            updateChannelButtonStyles();
            renderMapsList();
        }

        // ==================== HELPER: FETCH TITLE ====================
        async function fetchVideoTitle(videoUrl) {
            if (!videoUrl) return null;
            try {
                const response = await fetch(`https://noembed.com/embed?url=${encodeURIComponent(videoUrl)}`);
                const data = await response.json();
                return data.title;
            } catch {
                return null;
            }
        }

        // ==================== RENDER MAPS LIST ====================
        function renderMapsList() {
            mapsList.innerHTML = '';

            const maps = allChannelsData[currentChannel] || [];
            channelInfo.textContent = `${currentChannel} ‚Äî ${maps.length} items`;

            if (maps.length === 0) {
                mapsList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No items in this channel. Click "Add Item" to create one.</p>';
                return;
            }

            maps.forEach((map, index) => {
                mapsList.appendChild(createMapCard(map, index));
            });

            // Initialize SortableJS
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            sortableInstance = new Sortable(mapsList, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                handle: '.drag-handle',
                onEnd: () => {
                    updateDataFromDOM();
                    markChanged();
                }
            });
        }

        function createMapCard(map, index) {
            const card = document.createElement('div');
            card.className = 'map-card';
            card.dataset.index = index;

            card.innerHTML = `
                <div class="drag-handle">‚ò∞</div>
                <div class="map-card-content">
                    <h3 class="editable-title" title="Click to edit">Loading title...</h3>
                    <div class="links">
                        <a href="${escapeHtml(map.video_link)}" target="_blank">üìπ Video</a>
                        <a href="${escapeHtml(map.map_link)}" target="_blank">üéÆ Roblox</a>
                    </div>
                </div>
                <button class="delete-btn" title="Delete">‚úï</button>
            `;

            // Fetch Title
            fetchVideoTitle(map.video_link).then(title => {
                const titleEl = card.querySelector('h3');
                titleEl.textContent = title || map.video_link || 'No Title';
                // Store fetched title for edit modal (optional, but we assume it's read-only now)
            });

            // Edit handler (Click on content area, ignore links/buttons)
            card.querySelector('.map-card-content').addEventListener('click', (e) => {
                if (e.target.tagName === 'A') return;
                openEditModal(card, map);
            });

            // Delete handler
            card.querySelector('.delete-btn').addEventListener('click', (e) => {
                e.stopPropagation(); 
                if (confirm('Are you sure you want to delete this item?')) {
                    card.remove();
                    updateDataFromDOM();
                    markChanged();
                    const count = mapsList.querySelectorAll('.map-card').length;
                    channelInfo.textContent = `${currentChannel} ‚Äî ${count} items`;
                }
            });

            return card;
        }

        // ==================== ADD / EDIT ITEM ====================
        function openEditModal(card, mapData) {
            editingItemCard = card;
            
            // Update Modal Title
            addModal.querySelector('h2').textContent = card ? '‚úé Edit Item' : '‚ûï Add New Item';
            addModal.querySelector('button[type="submit"]').textContent = card ? 'Save Changes' : 'Add Item';

            // Fill form
            if (mapData) {
                document.getElementById('add-video-link').value = mapData.video_link || '';
                document.getElementById('add-map-link').value = mapData.map_link || '';
            } else {
                addForm.reset();
            }

            addModal.classList.remove('hidden');
        }

        addItemBtn.addEventListener('click', () => {
            openEditModal(null, null);
        });

        cancelAddBtn.addEventListener('click', () => {
            addModal.classList.add('hidden');
        });

        /*
        addModal.addEventListener('click', (e) => {
            if (e.target === addModal) {
                addModal.classList.add('hidden');
            }
        });
        */

        addForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const videoLink = document.getElementById('add-video-link').value;
            const mapLink = document.getElementById('add-map-link').value;

            const newMap = {
                video_link: videoLink,
                map_link: mapLink
            };

            if (editingItemCard) {
                // EDIT MODE: Update existing card
                const newCard = createMapCard(newMap, 0); // index doesn't matter here
                mapsList.replaceChild(newCard, editingItemCard);
            } else {
                // ADD MODE: Add to beginning
                const newCard = createMapCard(newMap, 0);
                mapsList.prepend(newCard);
            }

            updateDataFromDOM();
            markChanged();

            // Update channel info count
            const count = mapsList.querySelectorAll('.map-card').length;
            channelInfo.textContent = `${currentChannel} ‚Äî ${count} items`;

            addModal.classList.add('hidden');
        });

        // ==================== SAVE CHANGES ====================
        saveBtn.addEventListener('click', async () => {
            // Re-verify auth
            const user = auth.currentUser;
            if (!user) {
                showStatus(saveStatus, 'Not authenticated. Please sign in again.', 'error');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ Saving...';
            showStatus(saveStatus, 'Saving to Firestore...', 'loading');

            try {
                // Get existing Firestore data or create new
                const docRef = doc(db, 'content', 'main');
                const docSnap = await getDoc(docRef);
                let fullData = docSnap.exists() ? docSnap.data() : {};

                // Update maps and channel order
                fullData.maps = allChannelsData;
                fullData.channelOrder = channelOrder;

                // Save to Firestore
                await setDoc(docRef, fullData);

                showStatus(saveStatus, 'Triggering site update...', 'loading');

                // Trigger GitHub Action
                await triggerGitHubAction();

                showStatus(saveStatus, '‚úÖ Saved and published!', 'success');
                hasChanges = false;
                saveBtn.disabled = true;
            } catch (error) {
                console.error('Save error:', error);
                showStatus(saveStatus, 'Error: ' + error.message, 'error');
            } finally {
                saveBtn.textContent = 'üíæ Save Changes';
            }
        });

        async function triggerGitHubAction() {
            // Call the Cloud Function (PAT is safely stored on server)
            const triggerAction = httpsCallable(functions, 'triggerGitHubAction');
            const result = await triggerAction();
            console.log('GitHub Action triggered:', result.data);
        }

        // ==================== UTILITY FUNCTIONS ====================
        function updateDataFromDOM() {
            // Rebuild current channel's data from DOM order
            const newMaps = [];
            mapsList.querySelectorAll('.map-card').forEach(card => {
                const content = card.querySelector('.map-card-content');
                const links = content.querySelectorAll('.links a');

                newMaps.push({
                    map_name: content.querySelector('h3').textContent,
                    video_link: links[0].href,
                    map_link: links[1].href
                });
            });

            allChannelsData[currentChannel] = newMaps;
        }

        function markChanged() {
            hasChanges = true;
            saveBtn.disabled = false;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = `status-message show ${type}`;
        }

        function getErrorMessage(errorCode) {
            const messages = {
                'auth/invalid-email': 'Invalid email address format.',
                'auth/user-disabled': 'This account has been disabled.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/invalid-credential': 'Invalid login credentials.',
                'auth/too-many-requests': 'Too many failed attempts. Try later.'
            };
            return messages[errorCode] || 'An unexpected error occurred.';
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
